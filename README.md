# Кейс 2: Система идентификации личности по фотографии
*Описание*: Сейчас процесс проверки личности на проходной полностью ручной - на КПП дежурный сканирует пластиковый пропуск и "на глаз" проверяет сходство человека с фотографией в его профиле. Руководство предприятия хочет автоматизировать этот процесс, создав систему автоматического распознавания фото человека на проходной по базе сотрудников.

Количество сотрудников на предприятии ~5000. Количество проходных - 10.
## Состав команды
 - Зеленин Денис (data scientist)
 - Прокопец Семен (product owner)
 - Николай Игнатенков (Bombordiro crocolido)


## Бизнесс процесс до и после внедрения
### До 
![A-0 old.png](IDEF0%2FA-0%20old.png)
![A0 old.png](IDEF0%2FA0%20old.png)
### После
![A-0 new.png](IDEF0%2FA-0%20new.png)
![A0 new.png](IDEF0%2FA0%20new.png)

## Диаграммы структуры данных информационной системы
### Краткое описание 


- employees  
    Содержит данные о сотрудниках: имя, должность, отдел, дата приема на работу и ссылка на основное фото.

- photos  
    Хранит фотографии сотрудников. Каждая фотография связана с сотрудником через employee_id.

- gates  
    Информация о проходных (КПП): название, расположение и статус (активна/неактивна).

- roles  
    Определяет роли доступа (например, "администратор", "инженер"). Содержит разрешения в виде текста или JSON.

- employee_roles  
    Связывает сотрудников с их ролями (многие-ко-многим). Позволяет одному сотруднику иметь несколько ролей и одной роли быть назначенной нескольким сотрудникам.

- access_logs  
    Журнал событий прохода через КПП. Фиксирует время, тип события (вход/выход), уверенность системы в распознавании и информацию о сотруднике и проходной.

![ER.png](ER.png)
## 1 Цели и предпосылки
Цель разработки — автоматизировать процесс идентификации личности на проходных предприятия, чтобы заменить ручную проверку (сравнение фотографии на пропуске с лицом сотрудника) на более точное и быстрое решение.  
### Улучшения, которые придут с ML
 - Скорость: Автоматическая проверка займет секунды вместо ручного сравнения.

 - Точность: Исключается человеческий фактор (усталость, невнимательность).

 - Безопасность: Снижается риск проникновения посторонних (поддельные пропуска, передача карт доступа).

 - Масштабируемость: Система легко адаптируется под рост числа сотрудников (сейчас ~5000).

### Бизнес-требования и ограничения: 
#### Требования:

- Обрабатывать ~5000 сотрудников и 10 проходных.

- Интеграция с текущей системой учета пропусков.

- Минимальные задержки при проходе (чтобы не создавать очереди).

#### Ограничения:

- Разнообразие условий съемки (освещение, ракурс, наличие масок/очков).

- Необходимость высокой точности (ложные отказы могут блокировать легитимных сотрудников).

-  Защита персональных данных (фотографии сотрудников).

### Функциональные и нефункциональные требования

#### Функциональные:

- Распознавание лица по фото из базы.

- Сравнение в реальном времени с эталоном.

- Интеграция с турникетами/шлагбаумами.

- Логирование попыток входа.

#### Нефункциональные:

- Время обработки <1 секунды.

- Точность (по метрике).

- Работа при разном освещении/ракурсах.

- Отказоустойчивость (если система упала — переход на ручную проверку)

### Пилот и критерии успеха 

#### Пилот:

- Развернуть систему на 1-2 проходных.

- Тестировать на группе сотрудников (100-200 человек).

- Сравнивать скорость и точность с ручной проверкой.

#### Критерии успеха:

- Скорость идентификации ≤3 сек.

- Точность (ложные отказы <2%, ложные допуски <0.5%).

- Удовлетворенность сотрудников (опрос).

- Отсутствие сбоев в работе.

### MVP и технический долг

MVP:

- Работа с камеры (стандартные ракурсы).

- Интеграция с 1-2 проходными.

- Базовая система логирования.

- Простой интерфейс для администратора.

Технический долг:

- Поддержка масок/очков.

- Расширенная аналитика (подозрительные попытки доступа).

- Мультифакторная аутентификация

## Методология

### С технической точки зрения
Задача относится к компьютерному зрению и биометрии. Основные методы:

- Классификация (сравнение лица с фотографией из базы)

- Сиамские сети

- Детекция и выравнивание лиц

### Данные
*Обязательные*:
- База фотографий сотрудников (минимум 1-2 фото на человека, лучше в разных условиях)
*Желательные данные*:

- Примеры "негативных" случаев (попытки прохода посторонних)

- Данные о ложных срабатываниях/отказах (для дообучения модели)

### Метрики ML
- Precision (точность) – минимизация ложных допусков (чтобы не пропускать чужих).

- Recall (полнота) – минимизация ложных отказов (чтобы не блокировать своих).

- F1-score (баланс между Precision и Recall).

- Время инференса (должно быть <1 сек).

### Связь с бизнесом:

- Высокий Precision → меньше нарушителей пройдет.

- Высокий Recall → меньше жалоб от сотрудников.

- Быстрый инференс → нет очередей на проход

### Риски на этапе анализа и моделирования
| Риски                                        | Как минимизировать |
|----------------------------------------------|---|
| Низкое качество данных и маленькое количество фотографий | Аугментация данных, дообучение на реальных примерах  |
| Проблемы с разнообразием (маски, очки, бороды)                                             | Сбор дополнительных данных, использование моделей, устойчивых к атрибутам |
| Ложные срабатывания                                             | Настройка порога  |

## Подготовка и оценка пилота
### Метрики
- % успешных проходов (без ручного вмешательства).

- % ложных отказов (сотрудник не распознан).

- % ложных допусков (чужой прошел).

- Время прохода (сравнение с текущим процессом).
- Обратная связь от сотрудников
### Успешным считаем 
- Точность: F1-score > 95%.

- Скорость: Среднее время распознавания <1 сек.

- Надежность: Система работает без сбоев 90% времени.

- Удовлетворенность: >90% сотрудников не жалуются на новую систему.
### Подготовка пилота 
- Выбор тестовой зоны: 1-2 проходные, 100-200 сотрудников.

- Сбор данных:

    - Фотографии тестовой группы (если нет в базе).

    - Запись видео с камер в разных условиях (утро/вечер, дождь/солнце).

- Развертывание MVP:

  - Детекция лица → извлечение эмбеддингов → сравнение с базой.

  - Интеграция с турникетом (разблокировка при успешном распознавании).

- Мониторинг:

    - Логирование всех событий (успешные/неудачные проходы).

    - Сбор feedback от охраны и сотрудников.

## Архитектура решения 
### Компоненты:

- Клиентская часть (Edge-устройства):

  - Камеры на проходных (IP-камеры с поддержкой RTSP/ONVIF).

  - Локальные мини-серверы для предобработки видео (детекция лиц, обрезка, отправка на сервер).

- Backend-сервисы (Cloud/On-Premise):

  - API Gateway (Nginx, FastAPI) – прием запросов от камер, балансировка нагрузки.

  - Face Detection & Alignment (MTCNN, RetinaFace) – обнаружение и выравнивание лиц.

  - Face Recognition Model (ArcFace, FaceNet) – преобразование лица в эмбеддинг.

  - Vector Database (Milvus, FAISS) – быстрый поиск по базе сотрудников (~5000 эмбеддингов).

  - Auth Service – принятие решения (свой/чужой), логирование, интеграция с турникетом.

- Базы данных:

    - PostgreSQL – хранение профилей сотрудников (ID, имя, фото, доступы).

    - Redis – кэширование частых запросов (ускорение проверки).

- Мониторинг и логирование:

  - Prometheus + Grafana – метрики (latency, RPS, точность).

### Инфраструктура и масштабируемость

| Вариант                                        | Плюсы                                                                     | Минусы |
|----------------------------------------------|---------------------------------------------------------------------------|--------|
| Облако  | Автомасштабирование, готовая ML-инфраструктура                      | Зависимость от интернета, стоимость|
| On-Premise                                        | Полный контроль, низкая задержка|Высокие CAPEX, сложность масштабирования |

### Требования к работе системы
| Параметр | Ьребование                                     | Обоснование |
|----------|------------------------------------------------|-------|
| SLA      | 99.9% uptime | Минимизация простоев на проходных|
| RPS      | 	10-20 RPS на проходную          |Пиковая нагрузка |
| Latency  |             <1 сек (end-to-end)                                   |          Чтобы не создавать очереди                              |


### Риски и неопределенности



| Риски                                        | Как минимизировать |
|----------------------------------------------|---|
| Сбои интернета | Локальный кэш  |
| Проблемы с разнообразием (маски, очки, бороды)                                             | Сбор дополнительных данных, использование моделей, устойчивых к атрибутам |
| Рост нагрузки                                          | Автоскейлинг Kubernetes + кэширование запросов  |
|            Юридические ограничения                                            |    	Соответствие 152-ФЗ (хранение биометрии) |
|              Изменение условий освещения                                                                 |                                Дообучение модели на новых данных               |



